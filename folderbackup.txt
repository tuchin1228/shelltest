# 定義資料夾路徑
$sourceFolder = "C:\A"
$destFolder = "C:\B"
$backupBaseFolder = "C:\Backup"

# 建立今天日期的備份資料夾
$today = Get-Date -Format "yyyyMMdd"
$backupFolder = Join-Path $backupBaseFolder $today

# 建立備份資料夾（如果不存在）
if (-not (Test-Path $backupFolder)) {
    New-Item -ItemType Directory -Path $backupFolder -Force | Out-Null
}

Write-Host "備份資料夾: $backupFolder" -ForegroundColor Cyan

# 取得來源資料夾中的所有檔案
$sourceFiles = Get-ChildItem -Path $sourceFolder -Recurse -File

# 統計資訊
$totalFiles = $sourceFiles.Count
$backedUpFiles = 0
$movedFiles = 0

foreach ($file in $sourceFiles) {
    # 計算目標檔案的相對路徑
    $relativePath = $file.FullName.Substring($sourceFolder.Length)
    $destFilePath = Join-Path $destFolder $relativePath
    $backupFilePath = Join-Path $backupFolder $relativePath
    
    # 如果目標檔案已存在，需要備份
    if (Test-Path $destFilePath) {
        # 建立備份資料夾結構
        $backupFileDir = Split-Path $backupFilePath -Parent
        if (-not (Test-Path $backupFileDir)) {
            New-Item -ItemType Directory -Path $backupFileDir -Force | Out-Null
        }
        
        # 檢查備份檔案是否已存在，如果存在則加上流水號
        $finalBackupPath = $backupFilePath
        if (Test-Path $backupFilePath) {
            $fileInfo = Get-Item $backupFilePath
            $directory = $fileInfo.DirectoryName
            $baseName = $fileInfo.BaseName
            $extension = $fileInfo.Extension
            
            $counter = 1
            do {
                $counter++
                $newFileName = "$baseName-$counter$extension"
                $finalBackupPath = Join-Path $directory $newFileName
            } while (Test-Path $finalBackupPath)
        }
        
        # 複製到備份資料夾
        Copy-Item -Path $destFilePath -Destination $finalBackupPath -Force
        $backedUpFiles++
        Write-Host "已備份: $destFilePath -> $(Split-Path $finalBackupPath -Leaf)" -ForegroundColor Yellow
    }
    
    # 建立目標資料夾結構
    $destFileDir = Split-Path $destFilePath -Parent
    if (-not (Test-Path $destFileDir)) {
        New-Item -ItemType Directory -Path $destFileDir -Force | Out-Null
    }
    
    # 移動檔案（剪下）
    Move-Item -Path $file.FullName -Destination $destFilePath -Force
    $movedFiles++
    Write-Host "已移動: $relativePath" -ForegroundColor Green
}

# 顯示統計資訊
Write-Host "`n==================== 操作完成 ====================" -ForegroundColor Cyan
Write-Host "備份位置: $backupFolder" -ForegroundColor Cyan
Write-Host "總檔案數: $totalFiles" -ForegroundColor White
Write-Host "備份檔案數: $backedUpFiles" -ForegroundColor Yellow
Write-Host "移動檔案數: $movedFiles" -ForegroundColor Green
Write-Host "=================================================" -ForegroundColor Cyan
```

**運作邏輯：**

1. **備份資料夾**：永遠使用今天日期 `yyyyMMdd`（例如：`20250116`）
2. **檔案備份邏輯**：
   - 如果 `file.txt` 不存在於備份資料夾 → 直接備份為 `file.txt`
   - 如果 `file.txt` 已存在 → 備份為 `file.txt-2`
   - 如果 `file.txt-2` 也存在 → 備份為 `file.txt-3`
   - 以此類推

**執行範例：**

假設今天執行 3 次，每次都要覆蓋 `B\document.txt`：
```
Backup\20250116\
├── document.txt      (第一次執行的備份)
├── document.txt-2    (第二次執行的備份)
└── document.txt-3    (第三次執行的備份)
```

**輸出範例：**
```
備份資料夾: C:\Backup\20250116
已備份: C:\B\document.txt -> document.txt-2
已移動: \document.txt

==================== 操作完成 ====================
備份位置: C:\Backup\20250116
總檔案數: 1
備份檔案數: 1
移動檔案數: 1
=================================================