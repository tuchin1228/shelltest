
CODEQL_DIR
C:\codeql

CODEQL_EXE
C:\codeql\codeql.exe

CSPROJ_NAME
codescantest.csproj

======================
é©—è­‰
======================
$ErrorActionPreference = "Stop"
    
# æª¢æŸ¥ CodeQL æ˜¯å¦å­˜åœ¨
if (-not (Test-Path "$(CODEQL_EXE)")) {
  throw "æ‰¾ä¸åˆ° CodeQL CLI: $(CODEQL_EXE)"
}

# å°‡ CodeQL åŠ å…¥ PATH
$env:PATH = "$(CODEQL_DIR);$env:PATH"

Write-Host "=== CodeQL CLI è³‡è¨Š ==="
& codeql version


======================
ç”¨ vswhere æ‰¾åˆ° MSBuild
======================
$ErrorActionPreference = "Stop"
    
# ä½¿ç”¨ vswhere å°‹æ‰¾ Visual Studio å®‰è£è·¯å¾‘
$vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
if (-not (Test-Path $vswhere)) {
  throw "æ‰¾ä¸åˆ° vswhere.exe"
}

$vsPath = & $vswhere -latest -products * `
  -requires Microsoft.Component.MSBuild `
  -property installationPath

if (-not $vsPath) {
  throw "æ‰¾ä¸åˆ°åŒ…å« MSBuild çš„ Visual Studio"
}

# å˜—è©¦å¸¸è¦‹çš„ MSBuild è·¯å¾‘
$possiblePaths = @(
  "$vsPath\MSBuild\Current\Bin\MSBuild.exe",
  "$vsPath\MSBuild\15.0\Bin\MSBuild.exe"
)

$msbuild = $possiblePaths | Where-Object { Test-Path $_ } | Select-Object -First 1

if (-not $msbuild) {
  throw "æ‰¾ä¸åˆ° MSBuild.exe"
}

Write-Host "=== MSBuild è³‡è¨Š ==="
Write-Host "è·¯å¾‘: $msbuild"
& $msbuild -version

# å„²å­˜è®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
Write-Host "##vso[task.setvariable variable=MSBUILD_PATH]$msbuild"

================================
å»ºç«‹ CodeQL è³‡æ–™åº«
================================
$ErrorActionPreference = "Stop"
$env:PATH = "$(CODEQL_DIR);$env:PATH"

# è¨­å®šè·¯å¾‘
$sourceRoot = "$(Build.SourcesDirectory)"
$dbPath = Join-Path "$(Agent.TempDirectory)" "codeql-db"
$msbuild = "$(MSBUILD_PATH)"

# æ¸…ç†èˆŠçš„è³‡æ–™åº«
if (Test-Path $dbPath) {
  Remove-Item $dbPath -Recurse -Force
}

# å°‹æ‰¾å»ºç½®ç›®æ¨™ (.sln æˆ– .csproj)
$sln = Get-ChildItem $sourceRoot -Filter *.sln -Recurse | Select-Object -First 1
$target = if ($sln) {
  Write-Host "ä½¿ç”¨æ–¹æ¡ˆæª”: $($sln.FullName)"
  $sln.FullName
} else {
  $csproj = Get-ChildItem $sourceRoot -Filter *.csproj -Recurse | Select-Object -First 1
  if (-not $csproj) {
    throw "æ‰¾ä¸åˆ° .sln æˆ– .csproj æª”æ¡ˆ"
  }
  Write-Host "ä½¿ç”¨å°ˆæ¡ˆæª”: $($csproj.FullName)"
  $csproj.FullName
}

# å»ºç«‹å»ºç½®è…³æœ¬ (è™•ç†ç©ºç™½è·¯å¾‘å•é¡Œ)
$buildScript = Join-Path "$(Agent.TempDirectory)" "build.cmd"
@"
@echo off
"$msbuild" "$target" /t:Rebuild /p:Configuration=Release /p:Platform="Any CPU"
if %errorlevel% neq 0 (
"$msbuild" "$target" /t:Rebuild /p:Configuration=Release
)
"@ | Set-Content -Path $buildScript -Encoding ASCII

Write-Host "=== å»ºç«‹ CodeQL è³‡æ–™åº« ==="
Write-Host "ä¾†æºç›®éŒ„: $sourceRoot"
Write-Host "è³‡æ–™åº«è·¯å¾‘: $dbPath"
Write-Host "å»ºç½®ç›®æ¨™: $target"

# å»ºç«‹ CodeQL è³‡æ–™åº«
& codeql database create $dbPath `
  --language=csharp `
  --source-root=$sourceRoot `
  --command=$buildScript `
  --overwrite

if ($LASTEXITCODE -ne 0) {
  throw "CodeQL è³‡æ–™åº«å»ºç«‹å¤±æ•—"
}

Write-Host "âœ… CodeQL è³‡æ–™åº«å»ºç«‹æˆåŠŸ"
Write-Host "##vso[task.setvariable variable=CODEQL_DB_PATH]$dbPath"


==================================
åŸ·è¡Œ CodeQL åˆ†æ
==================================
$ErrorActionPreference = "Stop"
$env:PATH = "$(CODEQL_DIR);$env:PATH"

$dbPath = "$(CODEQL_DB_PATH)"
$outputPath = "$(Build.ArtifactStagingDirectory)\results.sarif"

# ç¢ºä¿è¼¸å‡ºç›®éŒ„å­˜åœ¨
$outputDir = Split-Path $outputPath
if (-not (Test-Path $outputDir)) {
  New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
}

# è¨­å®š CodeQL æš«å­˜ç›®éŒ„ (é¿å…æ¬Šé™å•é¡Œ)
$env:CODEQL_TMP_DIR = "$(Agent.TempDirectory)\codeql-tmp"
New-Item -ItemType Directory -Force -Path $env:CODEQL_TMP_DIR | Out-Null

Write-Host "=== åŸ·è¡Œ CodeQL åˆ†æ ==="
Write-Host "è³‡æ–™åº«: $dbPath"
Write-Host "è¼¸å‡º: $outputPath"

# ä¸‹è¼‰æŸ¥è©¢å¥—ä»¶
Write-Host "`nğŸ“¦ ä¸‹è¼‰ C# æŸ¥è©¢å¥—ä»¶..."
& codeql pack download codeql/csharp-queries

# åŸ·è¡Œåˆ†æ
Write-Host "`nğŸ” åŸ·è¡Œå®‰å…¨æ€§èˆ‡å“è³ªåˆ†æ..."
& codeql database analyze $dbPath `
  codeql/csharp-queries:codeql-suites/csharp-security-and-quality.qls `
  --format=sarif-latest `
  --output=$outputPath `
  --threads=0

if ($LASTEXITCODE -ne 0) {
  throw "CodeQL åˆ†æå¤±æ•—"
}

# é¡¯ç¤ºåˆ†æçµæœæ‘˜è¦
if (Test-Path $outputPath) {
  try {
    $sarif = Get-Content $outputPath -Raw | ConvertFrom-Json
    $resultCount = 0
    if ($sarif.runs -and $sarif.runs[0].results) {
      $resultCount = $sarif.runs[0].results.Count
    }
    
    Write-Host "`n=== åˆ†æçµæœ ==="
    Write-Host "ç™¼ç¾å•é¡Œæ•¸é‡: $resultCount"
    Write-Host "SARIF æª”æ¡ˆ: $outputPath"
    
    # é¡¯ç¤ºå‰ 10 å€‹å•é¡Œçš„æ‘˜è¦
    if ($resultCount -gt 0) {
      Write-Host "`nğŸ“‹ å•é¡Œæ‘˜è¦ (å‰ 10 é …):"
      $sarif.runs[0].results | Select-Object -First 10 | ForEach-Object {
        $ruleId = $_.ruleId
        $message = $_.message.text
        $location = ""
        if ($_.locations -and $_.locations[0].physicalLocation) {
          $uri = $_.locations[0].physicalLocation.artifactLocation.uri
          $line = $_.locations[0].physicalLocation.region.startLine
          $location = " [$uri`:$line]"
        }
        Write-Host "  â€¢ [$ruleId] $message$location"
      }
    }
    
    Write-Host "`nâœ… CodeQL åˆ†æå®Œæˆ"
  } catch {
    Write-Warning "ç„¡æ³•è§£æ SARIF æª”æ¡ˆ,ä½†åˆ†æå·²å®Œæˆ"
  }
} else {
  throw "æ‰¾ä¸åˆ° SARIF è¼¸å‡ºæª”æ¡ˆ"
}


================================
ç™¼ä½ˆçµ„å»ºæˆå“
================================
CodeAnalysisLogs