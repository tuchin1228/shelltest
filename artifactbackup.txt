# 參數設定
$buildArtifactPath = "$(System.DefaultWorkingDirectory)/$(Release.PrimaryArtifactSourceAlias)/drop"
$targetFolder = "$(TargetFolder)"
$backupRootFolder = "$(BackupRootFolder)"
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$releaseName = "$(Release.ReleaseName)"
$backupFolder = Join-Path $backupRootFolder "$timestamp`_$releaseName"

Write-Host "##[section]開始部署流程"
Write-Host "Release Name: $releaseName"
Write-Host "來源路徑: $buildArtifactPath"
Write-Host "目標路徑: $targetFolder"
Write-Host "備份路徑: $backupFolder"
Write-Host ""

try {
    # 檢查目標資料夾是否存在
    if (-not (Test-Path $targetFolder)) {
        Write-Host "##[warning]目標資料夾不存在，將建立新資料夾（無需備份）"
        New-Item -ItemType Directory -Path $targetFolder -Force | Out-Null
    } else {
        # 取得來源資料夾中的所有檔案
        Write-Host "##[command]檢查需要備份的檔案..."
        $sourceFiles = Get-ChildItem -Path $buildArtifactPath -Recurse -File
        $backedUpCount = 0
        
        foreach ($sourceFile in $sourceFiles) {
            # 計算目標檔案的相對路徑
            $relativePath = $sourceFile.FullName.Substring($buildArtifactPath.Length).TrimStart('\', '/')
            $targetFilePath = Join-Path $targetFolder $relativePath
            
            # 如果目標檔案存在，才進行備份
            if (Test-Path $targetFilePath) {
                # 計算備份檔案路徑
                $backupFilePath = Join-Path $backupFolder $relativePath
                $backupFileDir = Split-Path $backupFilePath -Parent
                
                # 建立備份資料夾結構
                if (-not (Test-Path $backupFileDir)) {
                    New-Item -ItemType Directory -Path $backupFileDir -Force | Out-Null
                }
                
                # 複製到備份資料夾
                Copy-Item -Path $targetFilePath -Destination $backupFilePath -Force
                $backedUpCount++
                Write-Host "  [備份] $relativePath" -ForegroundColor Yellow
            }
        }
        
        if ($backedUpCount -eq 0) {
            Write-Host "##[section]沒有檔案需要備份（全新檔案）" -ForegroundColor Green
        } else {
            Write-Host "##[section]✓ 已備份 $backedUpCount 個檔案到: $backupFolder" -ForegroundColor Green
        }
    }
    
    # 部署新檔案
    Write-Host ""
    Write-Host "##[command]部署新版本..."
    Copy-Item -Path "$buildArtifactPath\*" -Destination $targetFolder -Recurse -Force
    Write-Host "##[section]✓ 部署完成"
    
    # 清理舊備份（保留最近 5 次）
    Write-Host ""
    Write-Host "##[command]清理舊備份..."
    $backups = Get-ChildItem -Path $backupRootFolder -Directory | Sort-Object Name -Descending
    if ($backups.Count -gt 5) {
        $oldBackups = $backups | Select-Object -Skip 5
        foreach ($oldBackup in $oldBackups) {
            Remove-Item $oldBackup.FullName -Recurse -Force
            Write-Host "##[debug]已刪除舊備份: $($oldBackup.Name)"
        }
    }
    
    Write-Host ""
    Write-Host "##[section]========== 部署成功 =========="
    
} catch {
    Write-Host "##[error]部署失敗: $_"
    Write-Host "##[error]錯誤詳情: $($_.Exception.Message)"
    exit 1
}